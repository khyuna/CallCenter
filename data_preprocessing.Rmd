---
title: "Call Center Data Analysis"
author: "jinyoung, hyunah, suyoung, yunhwan"
date: "20170808"
output: html_document
---

# Call data import
```{r error=FALSE,message=FALSE,warning=FALSE}
#setwd("C:/CallCenter")
data<-read.csv("domino3_9.csv", header=TRUE)
#data<-read.csv("mister3_9.csv", header=TRUE)
```

# Call data import
```{r error=FALSE,message=FALSE,warning=FALSE}
library(ggplot2)
library(dplyr)
library(lubridate)
library(gridExtra)
```
# Excel preprocessing 

## holiday
* 공휴일을 나타내는 변수 
* 0:안쉬는날 / 1:하루 쉬는날 / 2:이틀 연속 쉬는날 / 3:삼일 이상 쉬는날 / 4:민족대명절
* naver에서 직접 공휴일 데이터 입력하여 domino4_2.csv를 생성한다.

## sports
* 소치 올림픽 경기를 나타내는 변수 
* 0:대한민국 경기가 아닌 것 / 1:대한민국 경기 중 매달 매치 아닌 경기 / 2:대한민국 경기중 매달 매치 경기
* daum에서 직접 경기 데이터를 입력하여 domino4_4.csv를 생성한다.
* 출처 : http://score.sports.media.daum.net/og/sochi/schedule/main.daum?date=20140223

## baseball 
* 프로야구 경기를 나타내는 변수 
* 1:시범경기 / 2:정규시즌 / 3:포스트시즌
* 출처 : http://www.koreabaseball.com/Schedule/Schedule.aspx



# Data preprocessing 

## date2
```{r error=FALSE,message=FALSE,warning=FALSE}
newDate<-paste(data$time, ':00', sep="")
data$date2<-paste(data$date, newDate)
```

## wday, wday_num 
```{r error=FALSE,message=FALSE,warning=FALSE}
data$date <- as.Date(data$date)
data$wday = wday(data$date, label=TRUE)
data$wday_num = wday(data$date)
data$wday_num = data$wday_num-1 
```

## total 
* total = count * duration 
* total 칼럼은 콜센터의 분주함을 나타내는 정도이다.
```{r error=FALSE,message=FALSE,warning=FALSE}
summary(data$duration)
data$total=data$count*data$duration
```

## domino Store Count 
* 서울, 경기의 가맹점 수가 50%를 차지한다. 
* 따라서 추후 날씨 데이터 적용에 있어서 서울, 경기 날씨데이터를 활용하도록 한다.
```{r error=FALSE,message=FALSE,warning=FALSE}

dstore<-read.csv("dominoStoreCount.csv")
slices<-c(dstore$count)
pct<-round(slices/sum(slices)*100)
lbls<-paste(dstore$location,pct)
lbls<-paste(lbls,"%", sep="")
p1 = pie(slices, col=rainbow(length(slices)), labels=lbls, main="Domino Pizza Store")

mstore<-read.csv("misterStore.csv")
slices<-c(mstore$count)
pct<-round(slices/sum(slices)*100)
lbls<-paste(mstore$location,pct)
lbls<-paste(lbls,"%", sep="")
p2 = pie(slices, col=rainbow(length(slices)), labels=lbls, main="Mister Pizza Store")



```
## prec, temp 
* prec은 강수량, temp는 기온을 나타내는 연속형 변수
* 출처 : https://data.kma.go.kr/cmmn/main.do
```{r error=FALSE,message=FALSE,warning=FALSE}
s_weather = read.csv("s_weather.csv", header=TRUE)
g_weather = read.csv("g_weather.csv", header=TRUE)
s_weather
g_weather

# 서울,경기 날씨 데이터 병합
merged_weather = merge(s_weather,g_weather,by.x="date",by.y="date",all.x=TRUE)
merged_weather[is.na(merged_weather)] <- 0
merged_weather

# 서울,경기 날씨 데이터 평균 
merged_weather$temp <- (merged_weather$temp.x + merged_weather$temp.y)/2
merged_weather$prec <- (merged_weather$prec.x + merged_weather$prec.y)/2

# Column Select 
summary_weather = select(merged_weather,c(date,temp,prec))
summary_weather

# data + summary_weather
data = merge(data,summary_weather, by.x="date2", by.y="date", all.x=TRUE)


```

## precClass, tempClass
* prec, temp 등 연속형 데이터를 범주화한 변수
* 집중호우 기준은 30mm이지만 30mm 이상인 경우가 거의 없어 10mm이상을 S클래스로 지정한다.
```{r error=FALSE,message=FALSE,warning=FALSE}
ggplot(data,aes(x=prec,y=count)) +
  geom_point()

data$precClass<-ifelse(data$prec==0,'N',ifelse(data$prec<5,'L',ifelse(data$prec<10, 'H','S')))
data$tempClass<-ifelse(data$temp<0,'0',ifelse(data$temp<10,'1',ifelse(data$temp<20, '2',ifelse(data$temp<30,'3','4'))))

```



## holiday order
* 3일 이상의 공휴일 중에서 몇째날인지 나타내는 변수 
* 0:3일 이상 공휴일이 아닌 날 / 1:첫번째날 / 2:두번째날 / 3:세번째날 / 4:네번째날
```{r error=FALSE,message=FALSE,warning=FALSE}

holidayRow<-filter(data, data$holiday==3)
temp1<-as.numeric(holidayRow$date[1])
holidayRow$holiday2[1]<-1
c<-1
for(i in 1:(nrow(holidayRow)-1))
{
  temp2<-as.numeric(holidayRow$date[i])
  temp3<-as.numeric(holidayRow$date[i+1])
  
  # next day
  if(temp1+1==temp2)
  {
    holidayRow$holiday2[i]<-c+1
    if(temp3>temp2)
    {
      temp1=temp2
      c<-c+1
    }
  }
  # same day
  else if(temp1==temp2)
  {
    holidayRow$holiday2[i]<-c
  }
  
  # other holiday
  # start new count
  else {
    c=1
    holidayRow$holiday2[i]<-1
    temp1=temp2
  }
}
holidayRow$holiday2[nrow(holidayRow)]<-holidayRow$holiday2[nrow(holidayRow)-1]

# merge holiday2
holiday3<-subset(holidayRow, select=c(date2, holiday2))
data<-merge(data, holiday3, by.x="date2", by.y="date2", all=TRUE)
data$holiday2[is.na(data$holiday2)]<-0

```


## dust 
* 출처 : https://data.kma.go.kr/cmmn/main.do
```{r error=FALSE,message=FALSE,warning=FALSE}
s_dust = read.csv("s_dust.csv", header=TRUE)
g_dust = read.csv("g_dust.csv", header=TRUE)
#View(s_dust)
#View(g_dust)

# 서울,경기 날씨 데이터 병합
merged_dust = merge(s_dust,g_dust,by.x="date2",by.y="date2")
merged_dust[is.na(merged_dust)] <- 0
merged_dust

# 서울,경기 날씨 데이터 평균 
merged_dust$dust <- (merged_dust$dust.x + merged_dust$dust.y)/2
merged_dust


# Column Select 
summary_dust = select(merged_dust,c(date2,dust))
summary_dust


# data + summary_weather
data = merge(data,summary_dust, by.x="date2", by.y="date2", all.x=TRUE)
data$dust[which(is.na(data$dust))]=0


```
## dustClass
* 300이상: 미세먼지 경보/ 150이상: 미세먼지 주의보
* 출처:http://www.airkorea.or.kr/warningActKnack
```{r error=FALSE,message=FALSE,warning=FALSE}
summary(data$dust)
plot(data$dust)
data$dustClass<-ifelse(data$dust<150,'N',ifelse(data$dust<300,'L','H'))

```
## data type
```{r error=FALSE,message=FALSE,warning=FALSE}

data$date2 = as.factor(data$date2)
data$date = as.factor(data$date)
data$time = as.factor(data$time)
data$holiday = as.factor(data$holiday)
data$sports = as.factor(data$sports)
data$baseball = as.factor(data$baseball)
data$wday_num = as.factor(data$wday_num)
data$precClass = as.factor(data$precClass)
data$tempClass = as.factor(data$tempClass)
data$holiday2 = as.factor(data$holiday2)
data$dustClass = as.factor(data$dustClass)
data$year = as.factor(data$year)
data$month = as.factor(data$month)
data$day = as.factor(data$day)

write.csv(data,'domino.csv')
#write.csv(data,'mister.csv')

```